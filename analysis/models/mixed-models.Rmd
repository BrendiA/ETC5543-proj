---
title: "Mixed Effects Model"
author: "Brendi Ang"
date: "15/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(broom.mixed)
library(colorspace)
library(lme4)
library(kableExtra)
library(naniar)
library(patchwork)

ggplot2::theme_set(theme_bw())

select <- dplyr::select
```

# Clean Data

```{r, include=FALSE, warning=FALSE}
# Read-in data
mathsci_all <- read_csv(here::here("data/mathsci_all.csv"),
                        col_types = cols(doe_centre_code = col_factor()))

# --- Clean district names

# Remove 'District' in `qcaa_district` as there are repeated districts
mathsci_all <- mathsci_all %>% 
  mutate(qcaa_district = str_to_title(qcaa_district)) %>% 
  # Remove words that has a space (\s), followed by the word "District"
  mutate(qcaa_district = str_remove_all(qcaa_district, "\\sDistrict")) 

# --- Clean sector names

mathsci_all <- mathsci_all %>% 
  mutate(sector = case_when(
    sector == "SCAT" ~ "Catholic",
    sector == "SIND" ~ "Independent",
    sector == "SGOV" ~ "Government",
    TRUE ~ sector
  )) %>% 
  # Remove overseas sector (SOVS), and sectors with only 1 entry (JIND, SPEC) and SCOL
  filter(sector %in% c("Catholic", "Independent", "Government"))

# --- Change data types
mathsci_all <- mathsci_all %>% 
  mutate(across(.cols = c(subject_name,
                          subject_type,
                          qcaa_school_id,
                          school_postcode,
                          qcaa_district),
                ~ as.factor(.x)))
```

- ‘Enrolment’ refers to the students who are enrolled in a unit or Short Course.
- Generally, most students complete Units 1 and 2 in Year 11 and Units 3 and 4 are undertaken in Year 12. However, schools have some flexibility to teach and assess students in the order that best suits their local context. This includes options such as early entry and completion, accelerated, compressed (compressing four units into one year) or extended completion.
- `completion_year` refers to the year students complete the subject, e.g. data for the 2022 completion year indicates enrolments in those subjects in Units 1 and 2 in 2021 (generally Year 11) and Units 3 and 4 in 2022 (generally Year 12).

- 2019 graduating cohort was smaller than usual because these students were part of Queensland’s first Prep Year cohort in 2007
- 2020 Year 12 cohort was the first to graduate in the new Queensland Certificate of Education (QCE) system.

```{r}
# Reformat subject id for science in practice so they're consistent
mathsci_all <- mathsci_all %>% 
  mutate(qcaa_subject_id = if_else(qcaa_subject_id == 6248, 
                                   true = 6421,
                                   false = qcaa_subject_id))
```
- Science in practice had a change in subject_id
  - This may be attributed to the literature review that stated that there was signifncant overlap between Science21 and Science in Practice subject, which allowed integration of practical elements from Science in Practice into all senior science subjects as more emphasis on project-based learning is enhanced (see *snr_syll_redev_science_lit_review*)
  - This allows Science in Practice to be credited towards theirOverall Positions (Ops) and Field Positions (FPs) based on the old QCE system

```{r}
mathsci_subj <- mathsci_all %>% 
  filter(between(completion_year, 2010, 2019)) %>% 
  group_by(completion_year, subject_name) %>% 
  distinct(qcaa_subject_id) 

# Maths and Science subject Offerings from 2010 to 
mathsci_subj %>%
  group_by(completion_year) %>% 
  arrange(completion_year, qcaa_subject_id) %>% 
  mutate(test = paste0(subject_name, "(", qcaa_subject_id, ")", collapse = ", ")) %>% 
  distinct(completion_year, test) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE,
                bootstrap_options = c("striped"))
```

### EDA

```{r}
# Convert data to long format for modelling & plotting
mathsci_all_long <- mathsci_all %>% 
  pivot_longer(cols = c(year_11_enrolments, year_12_enrolments),
               names_to = "unit",
               values_to = "enrolments") 
```

```{r, message=FALSE, fig.height = 10}
# Violin plot
mathsci_all_long %>% 
  filter(enrolments > 0) %>% 
  ggplot(aes(x = unit, 
             y = enrolments)) +
  geom_violin(width = 0.8,
              aes(fill = unit)) +
  geom_boxplot(outlier.alpha = 0.4,
               width = 0.2) +
  facet_wrap(~ subject_name,
             scales = "free") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x.bottom = element_blank()) +
  scale_fill_discrete_qualitative() +
  labs(title = "Distribution and summary statistics of enrolments")
```

```{r}
# Density plots for each subject
mathsci_all_long %>% 
  filter(between(completion_year, 2010, 2018)) %>% 
  ggplot() +
  ggridges::geom_density_ridges(aes(x = enrolments,
                                    y = subject_name,
                                    fill = unit),
                                alpha = 0.6) +
  labs(title = "Distribution of enrolments from 2010 to 2018",
       x = "Enrolments", 
       y = "Subject Name") +
  theme(legend.position = "bottom")
```

**qq plot**
- Most subjects enrolments are **right skewed**, such as Biology, Chemistry, Essential Mathematics, General Mathematics, Mathematical Methods, Physics
  - This may be attributed to the different school sizes 
  
**Ridges plot**
- Most units exhibited the same enrolment numbers


# Schools nested within Districts

Our data has 403 schools spread across 13 different districts.

As enrolment number of students vary across schools at different district, mixed models may be utilised. Since various schools are within a district, school is nested within districts.

Each unit (year 11 and year 12) should also be treated as random effects.


## Subset data

Run first mixed effects model with one mathematics subject (*Specialist Mathematics*) first.

```{r}
# --- Specialist Mathematics subject 
spec_math <- mathsci_all %>%
  filter(subject_name == "Specialist Mathematics") 

# --- Convert to long format for modelling & plotting
spec_math_long <- spec_math %>% 
  pivot_longer(cols = year_11_enrolments:year_12_enrolments,
               names_to = "unit",
               values_to = "enrolments") 
```

```{r}
# First enrolments for first 10 schools
spec_math_long %>% 
  # School ID < 10
  filter(as.numeric(as.character(qcaa_school_id)) <= 10) %>% 
  ggplot(aes(x = completion_year, y = enrolments)) +
  geom_line(aes(group = qcaa_school_id)) +
  facet_grid(qcaa_school_id ~ unit,
             scales = "free_x") +
  labs(title = "Simple time plot for the first 10 schools in the dataset",
       x = "Completion Year",
       y = "Enrolments")
```

- There seems to be variations within schools
- Some schools discontinued Specialist Mathematics subject (*e.g.* `qcaa_school_id` 1) earlier while some schools introduced the subject in the later years (*e.g.* `qcaa_school_id` 8)

### Simple Linear Model

- Building a simple model acts as a good starting place
  - provides visual intuition to capture potential trends or problems
  - Model can also be used to compare with the more complex model

```{r}
# Fit linear model for all schools separately
ml_school <- spec_math_long %>% 
  group_by(qcaa_school_id) %>% 
  summarise(tidy(lm(enrolments ~ completion_year + unit)),
            .groups = "drop") %>% 
  select(qcaa_school_id, term, estimate) %>% 
  pivot_wider(names_from = term, 
              values_from = estimate) %>% 
  rename(intercept = `(Intercept)`)

# Plot linear model for all schools
ml_school %>% 
  ggplot() +
  geom_point(aes(y = intercept,
                 x = unityear_12_enrolments,
                 colour = if_else(unityear_12_enrolments > 0, "blue", "green")),
             alpha = 0.8) +
  theme(legend.position = "none") +
  scale_colour_discrete_qualitative() 
```

**Slope vs intercept**
- There seems to be little correlation
  - Relative to year 11 enrolments, most year 12 enrolments see little to no change (as shown by the group centered around zero)


### Multiple linear regression model

- Multilevel model: Models with nested (hierarchical) structure

It is possible that schools within each district are more similar to each other than data from different schools; they are correlated.

```{r}
# --- EDA

# Box plot: Enrolments against district
spec_math_long %>% 
  ggplot() +
  geom_boxplot(aes(x = qcaa_district,
                   y = enrolments)) +
  theme(axis.text.x = element_text(angle = 90))

# Line plot: Enrolments against completion_year, colour by district
spec_math_long %>% 
  ggplot() +
  geom_line(aes(x = completion_year, 
                y = enrolments, 
                group = qcaa_school_id, 
                colour = qcaa_district),
            alpha = 0.7) +
  facet_wrap(~ unit,
             nrow = 2) +
  colorspace::scale_colour_discrete_qualitative(palette = "Dark2")

# Colour by districts
spec_math_long %>% 
  ggplot() +
  geom_line(aes(x = completion_year, 
                y = enrolments, 
                group = qcaa_school_id),
            colour = "grey80",
            alpha = 0.7) +
  geom_line(aes(x = completion_year, 
                y = enrolments, 
                group = qcaa_school_id,
                colour = qcaa_district),
            alpha = 0.4,
            data = filter(.data = spec_math_long ,qcaa_district == "Brisbane Central")) +
  scale_colour_manual(values = "brown",
                      aesthetics = "colour") +
  facet_wrap(~ unit,
             nrow = 2) +
  labs(title = "Enrolments for Specialist Mathematics in Brisbane Central, relative to other schools",
       x = "Completion year",
       y = "Enrolments") +
  theme(legend.position = "bottom",
        title = element_text(size = 8)) 
```

**Box plot**
- There seems to be some differences in enrolments among the districts
  - *e.g.* Enrolments in British Central is higher as compared to the other districts, on average
  
**Line Plot**
- It seems the enrolments in Brisbane Central are higher among other districts
- Generally, Wide Bay district have little enrolments in Specialist Mathematics subjects
  - There seem to be a dip in enrolments in 2019, where enrolments for most schools were 0


```{r}
# ------ Fit linear model for all districts separately

ml_district <- spec_math_long %>% 
  group_by(qcaa_district) %>% 
  # Fit linear models
  summarise(tidy(lm(enrolments ~ completion_year + unit)),
            .groups = "drop") %>% 
  select(qcaa_district, term, estimate) %>% 
  # Convert to wide form
  pivot_wider(names_from = term, 
              values_from = estimate) %>% 
  rename(intercept = `(Intercept)`)

# Plot intercept terms
ml_district %>% 
  ggplot() +
  geom_point(aes(y = intercept,
                 x = unityear_12_enrolments)) +
  theme(legend.position = "none") +
  scale_colour_discrete_qualitative() +
  labs(x = "Slope",
       y = "Intercept")
```

- The linear model indicates that all districts have a have lower enrolment scores in year 12, as compared to year 11
- As our goal is to know if enrolments are decreasing with the new QCE system, we can simply 'control the variation' from the various districts
  - $\therefore$ It is better to use mixed effects model

### Mixed Effects Model

- Enrolments have some residual variation (*i.e.* unexplained variation) associated with district. 
- By using random effects, this unexplained variation can be modelled through variance.
  - That is, the random effect of `qcaa_district` is meant to capture all influences of districts on the enrolments

```{r}
# Create new completion year variable starting from 0 (Numerically more stable)
spec_math_long <- spec_math_long %>% 
  mutate(completion_year2 = completion_year - min(completion_year),
         .after = completion_year) %>% 
  # Remove 0 enrolments (So we can take the logarithm)
  filter(enrolments != 0)

# Center and standardise enrolments
spec_math_long <- spec_math_long %>% 
  mutate(c_enrolments = (enrolments - mean(enrolments))/sd(enrolments))

# Fit mixed effects model
district_lmer <- lme4::lmer(c_enrolments ~ 
                            completion_year2 + unit + # Fixed effects
                            (completion_year2 | qcaa_school_id:qcaa_district), # Random effects
                            data = spec_math_long)
```

- 100 is added to enrolments for each school to remove effect of some schools having very low enrolments for short period of times


### Examine random effects

```{r, eval=FALSE}
# Caterpillar plot
as_tibble(ranef(district_lmer)) %>% 
  ggplot() +
  geom_point(aes(x = condval,
                 y = grp)) +
  geom_errorbar(aes(xmin = condval - condsd,
                    xmax = condval + condsd,
                    y = grp)) +
  facet_wrap(~ term,
             scales = "free")
  

ranef(district_lmer, condVar = T)

library(lattice)
dotplot(ranef(district_lmer, condvar = TRUE))

library(merTools)
merTools::predictInterval(district_lmer, n.sims = 100)
```

- There seems to be a negative correlation between the random intercept and the random slope

```{r}
# Extract conditional mean of random effects: E(gamma | y)
corrected_enrol <- as_tibble(ranef(district_lmer)) %>% 
  select(term, grp, condval) %>% 
  # Convert to wide format
  pivot_wider(names_from = term,
              values_from = condval) %>% 
  rename(adj_intcp = `(Intercept)`,
         adj_slope = completion_year2,
         qcaa_district = grp)

# Separate district and school id 
corrected_enrol <- corrected_enrol %>% 
  separate(qcaa_district, c("qcaa_school_id", "qcaa_district"), sep = ":")
 
# Add raw intercept for each school (`qcaa_school_id`)
corrected_enrol <- corrected_enrol %>% 
  mutate(raw_intcp = coef(lm(enrolments ~ qcaa_school_id - 1, data = spec_math_long)))

# Add raw slope for each school (`qcaa_school_id`)
raw_slope <- spec_math_long %>% 
  group_by(qcaa_school_id) %>% 
  # Fit linear model (ignoring correlation between schools within districts)
  summarise(raw_slope = lm(enrolments ~ completion_year2)$coef["completion_year2"],
            .groups = "drop") 

# Add raw slope into corrected enrolments tibble
corrected_enrol <- corrected_enrol %>% 
  left_join(raw_slope, by = "qcaa_school_id") 

# Scale enrolments for raw & adjusted scores so they're on the same scale
corrected_enrol <- corrected_enrol %>%
  mutate(across(where(is.numeric), ~ (.x - mean(.x, na.rm = T))/sd(.x, na.rm = T)))

# Add original dataset into model output
corrected_enrol <- spec_math %>% 
  # Extract unique school details
  distinct(qcaa_school_id, school_name, sector, school_postcode) %>% 
  right_join(corrected_enrol, by = "qcaa_school_id")
```


```{r intcp-slope, fig.cap = "Plot of adjusted intercept against adjusted slope reveals correlation between random effects"}
# Adjusted intercept against adjusted slope (based on mixed effects model)
p1 <- corrected_enrol %>% 
  ggplot(aes(y = adj_intcp,
             x = adj_slope)) +
  geom_point() +
  labs(title = "Adjusted slope against adjusted intercept in mixed effects model",
       x = "Adjusted slope",
       y = "Adjusted intercept") +
  theme(title = element_text(size = 8))

# Raw slope & intercept (ignoring dependence of schools within a district)
p2 <- corrected_enrol %>% 
  ggplot(aes(x = raw_slope,
             y = raw_intcp)) +
  geom_point() +
  labs(title = "Adjusted slope against adjusted intercept in linear model (ignores dependence of schools)",
       x = "Raw slope",
       y = "Raw intercept") +
  theme(title = element_text(size = 8))
  
p1 / p2
```

**Adjusted intercept against adjusted slope**
- There seems to be a somewhat negative correlation It appears that school with high adjusted intercept tend to have lower adjusted slopes and vice versa.

**Raw intercept against raw slope**
- Simple linear models ignores the correlation within districts
  - The model shows no clear patterns between the intercept and the slope

```{r raw-adj-intercept, fig.cap = "Adjusted intercept against raw intercepts, with a 45° line to guide reader"} 
library(ggrepel)

# Plot random intercept for each school
corrected_enrol %>% 
  ggplot(aes(x = raw_intcp,
             y = adj_intcp,
             label = school_name)) +
  geom_point(alpha = 0.5) +
  geom_label_repel(data = filter(corrected_enrol,
                                 adj_intcp > 4 |
                                 raw_intcp > 4),
                   nudge_y = 0.5,
                   nudge_x = -0.1,
                   label.size = 0.1,
                   size = 2
                   ) +
  geom_abline(intercept = 0,
              slope = 1,
              colour = "red") +
  labs(title = "Adjusted intercept against raw intercepts, with a 45° line")
```

```{r}
# Plot random slope for each school
corrected_enrol %>% 
  mutate(qcaa_school_id = fct_reorder(qcaa_school_id, adj_slope)) %>% 
  ggplot(aes(x = adj_slope,
             y = qcaa_school_id)) +
  geom_point() + 
  geom_vline(xintercept = 0,
             colour = "red") +
  theme(axis.text.y = element_text(size = 7)) +
  labs(title = "Conditional means for each school, by school ID")
```

```{r}
corrected_enrol %>% 
  ggplot(aes(x = raw_slope, y = adj_slope,
             label = qcaa_district)) +
  geom_point() +
  geom_abline(slope = 1,
              intercept = 0,
              colour = "red") +
  geom_label_repel(data = filter(corrected_enrol,
                                 adj_slope > 4 |
                                 raw_slope < -4),
                   nudge_y = 2) +
  labs(title = "Adjusted slopes against raw slopes, with a 45° line",
       x = "Raw slope",
       y = "Adjusted slope")
```

### Model Diagnostics

#### QQ-plots

```{r}
# Random effects
as_tibble(ranef(district_lmer)) %>% 
  ggplot(aes(sample = condval)) +
  geom_qq() +
  geom_qq_line(colour = "steelblue") +
  facet_wrap(~ term,
             scales = "free")

# Residuals
broom.mixed::augment(district_lmer) %>% 
  ggplot(aes(sample = .resid)) +
  geom_qq() +
  geom_qq_line(colour = "steelblue") 
```

$$\begin{aligned} &\begin{bmatrix} \gamma_0 \\ \gamma_1 \end{bmatrix} \sim N(0, \hat{D}) \\ where, & \\ \hat{D} &= \begin{bmatrix} var(\gamma_0) & cov(\gamma_0, \gamma_1) \\ cov(\gamma_0, \gamma_1) & var(\gamma_1) \end{bmatrix} \end{aligned}$$
**Random effects**
- The conditional random effects $E(\gamma ~|~ y)$ can be assessed for normality using quantile-quantile (QQ) plots
- Both random slope and random intercept displayed similar characteristics, where observations are skewed to the right
  - On overall, random effects seems to adhere to normality assumptions
  
**Residuals**
- Residuals have fat tails, and does not look normally distributed

#### Residual against fitted plots

```{r}
# Residuals against fitted 
broom.mixed::augment(district_lmer) %>% 
  ggplot(aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0,
             colour = "red")
```

- Heteroscedasticity seems to be clear
- Some diagonal lines due to discretisation of enrolment numbers

# Schools nested within districts, districts nested within sectors

- Data collected within sectors (Catholics, independent or government) may be correlated
  - Therefore, we can include an additional random effect into the model
  
```{r}
# Create explicitly nested factor
spec_math_long <- spec_math_long %>% 
  mutate(district_sector = paste0(qcaa_district, ":", sector))
```

```{r}
ggplot(spec_math_long) +
  geom_boxplot(aes(y = enrolments,
                 x = sector)) +
  facet_wrap(~ qcaa_district,
             scales = "free") 
```

- Large variations can be seen within each sector in each district

```{r}
lme4::lmer(enrolments ~ completion_year2 + (1 | qcaa_district) + (1 | district_sector),
           data = spec_math_long)


lme4::lmer(enrolments ~ completion_year2 + (1 | qcaa_district) + (1 | district_sector),
           data = spec_math_long)
```

```{r}
glance(district_lmer)$AIC
```
  

## Data

```{r}
spec_math_long %>% 
  ggplot() +
  geom_boxplot(aes(x = qcaa_district, y = enrolments, fill = sector)) +
  theme(axis.text.x = element_text(angle = 90)) +
  colorspace::scale_fill_discrete_qualitative()
```

- There appears to be some variations across the different sectors

# Mixed-effects model (Schools nested within postcode)

## EDA

```{r}
spec_math_long %>% 
  ggplot(aes(x = fct_reorder(school_postcode, enrolments), 
             y = enrolments,
             fill = qcaa_district)) +
  geom_boxplot() +
  facet_wrap(~ unit) +
  theme(axis.text.x = element_text(angle = 90))

spec_math %>% 
  drop_na() %>% 
  filter(year_11_enrolments > 0, year_12_enrolments > 0) %>% 
  ggplot() +
  geom_point(aes(x = year_11_enrolments, y = year_12_enrolments),
             alpha = 0.5)
```

Clear positive correlation between year 11 and year 12 enrolments

## Simple Regression Model

```{r}
# ----- Fit simple linear model for one school
lmod <- lm(enrolments ~ c_completion_year + unit, data = spec_math_long)
summary(lmod)
```

- t-test tells us that year 11 and year 12 unit enrolments are not significantly different at the 5% level

## Mixed Effects Model

```{r}
# Completion year as fixed effect
# Postcode as random effect, fixed slope

# Fit mixed effects model
postcode_lmer <- 
  lme4::lmer(c_enrolments ~ completion_year2 + unit + 
                          (completion_year2 | qcaa_school_id:school_postcode), 
             data = spec_math_long)

postcode_lmer <- 
  lme4::lmer(c_enrolments ~ completion_year2 + unit + 
                          (0 + completion_year2 | qcaa_school_id/school_postcode), 
             data = spec_math_long)
``` 

- Centering of `year` is required as the values of `year` is large, but the variations are small

```{r}
# Extract fixed-effects slope
fixed_slope <- fixef(postcode_lmer)["completion_year2"]

# Extract random-effect slopes for county
random_slope <- as_tibble(ranef(postcode_lmer)) %>% 
  filter(term == "completion_year2") 

postcode_slope <- random_slope %>% 
  select(term, grp, condval) %>% 
  # postcode-level random effects needs to be added by fixed-effect slopes
  mutate(slope = completion_year2 + fixed_slope)  %>% 
  rownames_to_column(var = "school_postcode")
```

```{r}
# Include district (to colour)
postcode_slope <- spec_math_long %>% 
  select(qcaa_district, school_postcode) %>% 
  right_join(postcode_slope, by = "school_postcode")

# Visualise results
postcode_slope %>% 
  mutate(school_postcode = fct_reorder(school_postcode, slope)) %>% 
  ggplot(aes(x = slope,
             y = school_postcode)) +
  geom_point() +
  geom_vline(xintercept = 0,
             colour = "red") +
  labs(y = "Postcode",
       x = "Change in enrolments per year") 

# Facet by district
postcode_slope %>% 
  mutate(school_postcode = fct_reorder(school_postcode, slope)) %>% 
  ggplot(aes(x = slope,
             y = school_postcode)) +
  geom_point() +
  geom_vline(xintercept = 0,
             colour = "red") +
  facet_wrap(~ qcaa_district,
             scales = "free_y")
```

```{r}
spec_math_long %>% 
  mutate(pred = predict(postcode_lmer)) %>% 
  ggplot() +
  geom_line(aes(x = completion_year, y = pred, group = school_postcode)) +
  facet_grid(qcaa_district ~ unit)
```

```{r}
spec_math_long %>% 
  ggplot(aes(x = completion_year,
             y = enrolments)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ qcaa_district)

spec_math_long %>% 
  ggplot(aes(x = completion_year,
             y = enrolments)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ sector)
```

# All Schools

```{r}
mathsci_all <- mathsci_all %>% 
  # Remove parentheses relating to suburb
  mutate(school_name = str_remove(school_name, " \\(.*\\)")) %>% 
  # Remove suburb by extracting all text before the last "-"
  mutate(school_name = str_replace(school_name, pattern = '(.*)\\s+\\-.*', '\\1')) %>% 
  mutate(school_name = if_else(school_name == "Cloncurry State School P",
                               true = "Cloncurry State School",
                               false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "Bayside Christian College Hervey Bay",
                               true = "Bayside Christian College",
                               false = school_name)) %>% 
  # Change name of school to newest name
  mutate(school_name = if_else(school_name == "Tropical North Learning Academy",
                               true = "Smithfield State High School",
                               false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "St Catherine's Catholic College The Whitsundays",
                               true = "St Catherine's Catholic College",
                               false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "Aboriginal & Islander Independent Community School",
                               true = "Aboriginal and Islander Independent Community School",
                               false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "The SCOTS PGC College",
                               true = "Scots PGC College",
                               false = school_name)) %>% 
  mutate(school_name = if_else(str_detect(school_name, "Marist College"),
                               true = "Marist College",
                               false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "The Cathedral School of St Anne and St James",
                                true = "The Cathedral School",
                                false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "St Andrew's Catholic College Redlynch Valley",
                                true = "St Andrew's Catholic College",
                                false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "Spinifex State College Mount Isa",
                                true = "Spinifex State College",
                                false = school_name)) %>% 
  mutate(school_name = if_else(school_name == "Cloncurry State School P-12",
                                true = "Cloncurry State School",
                                false = school_name)) %>% 
  # Capital K in MacKillop
  mutate(school_name = if_else(school_name == "Clairvaux MacKillop College",
                               true = "Clairvaux Mackillop College",
                               false = school_name)) %>% 
  # Extra " ' " in Girls
  mutate(school_name = if_else(school_name == "St Aidan's Anglican Girls' School",
                                true = "St Aidan's Anglican Girls School",
                                false = school_name))
```


```{r}
mathsci_all_long <- mathsci_all %>% 
  pivot_longer(cols = year_11_enrolments:year_12_enrolments,
               names_to = "unit",
               values_to = "enrolments")
```


### Work in progress

```{r}
spec_math_long <- spec_math_long %>% 
  group_by(qcaa_school_id) %>% 
  summarise(school_mean = mean(enrolments))

spec_math_long %>% 
  ggplot(aes(x = completion_year,
                y = c_enrolments,
                group = qcaa_school_id)) +
  geom_line(colour = "grey80",
            alpha = 0.5) +
  geom_line(data = filter(.data = spec_math_long, 
                          qcaa_district == "Brisbane South"),
            colour = "red") +
  facet_wrap(~ unit)

lme4::lmer(c_enrolments ~ completion_year2 + unit + school_mean + (1 | qcaa_school_id/qcaa_district), data = spec_math_long)
```

# ANOVA test

```{r}
mathsci_all_long %>% 
  ggplot(aes(x = completion_year,
             y = enrolments)) +
  geom_line(aes(group = qcaa_school_id),
            colour = "grey80") +
  geom_line(aes(group = qcaa_school_id),
            colour = "red",
            data = filter(mathsci_all_long,
                          qcaa_school_id == 17)) + 
  facet_grid(subject_name ~ unit,
             scales = "free")
```
