---
title: "Multilevel Model for Science in Practice"
author: "Brendi Ang"
date: "17/10/2021"
output: 
  bookdown::html_document2:
    theme: flatly
    toc: true
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include=FALSE}
library(tidyverse)
library(broom)
library(broom.mixed)
library(colorspace)
library(kableExtra)
library(lme4)
library(patchwork)

ggplot2::theme_set(theme_bw())

select <- dplyr::select
```

```{r, include=FALSE, warning=FALSE}
# Read-in data
mathsci_all <- read_csv(here::here("data/mathsci_all.csv"),
                        col_types = cols(doe_centre_code = col_factor()))

# Convert data types
mathsci_all <- mathsci_all %>% 
  mutate(across(.cols = c(qcaa_subject_id, 
                          subject_type,
                          qcaa_school_id,
                          sector,
                          school_postcode
                          ),
                ~ as.factor(.x))) 
```

```{r}
sci_prac<- mathsci_all %>% 
  filter(subject_name == "Science in Practice")

sci_prac_long <- sci_prac %>% 
  pivot_longer(cols = year_11_enrolments:year_12_enrolments,
               names_to = "unit",
               values_to = "enrolments") 
```

```{r}
mathsci_all %>% 
  ggplot() +
  geom_line(aes(x = completion_year,
                y = year_11_enrolments,
                group = qcaa_school_id)) +
  facet_wrap(~ subject_name,
             scales = "free_y")
```


# Getting the data ready for modelling

## Removing graduating cohort 2019

```{r}
# Year 11 enrolments
p1 <- sci_prac_long %>% 
  filter(unit == "year_11_enrolments",
         enrolments != 0) %>% 
  ggplot() +
  geom_line(aes(x = completion_year,
                y = enrolments,
                group = qcaa_school_id),
            alpha = 0.5,
            colour = "grey40") +
  facet_wrap(~ unit) +
  scale_x_continuous(breaks = seq(1992, 2022, by = 2),
                     labels = seq(1992, 2022, by = 2)) +
  theme(axis.text.x = element_text(angle = 90),
        title = element_text(size = 8)) +
  labs(title = "Enrolments including 2019")

# Year 11 enrolments
p2 <- sci_prac_long %>% 
  filter(unit == "year_11_enrolments",
         completion_year != 2019,
         enrolments != 0) %>% 
  ggplot() +
  geom_line(aes(x = completion_year,
                y = enrolments,
                group = qcaa_school_id),
            alpha = 0.5,
            colour = "grey40") +
  facet_wrap(~ unit) +
  scale_x_continuous(breaks = seq(1992, 2022, by = 2),
                     labels = seq(1992, 2022, by = 2)) +
  theme(axis.text.x = element_text(angle = 90),
        title = element_text(size = 8)) +
  labs(title = "Enrolments excluding 2019")

p1 / p2
```

## Linearise response variable using log transformation

```{r}
p1 <- sci_prac_long %>%
  ggplot(aes(x = enrolments)) +
  geom_histogram() +
  labs(title = "Before log transformation")

p2 <- sci_prac_long %>%
  ggplot(aes(x = log(enrolments))) +
  geom_histogram() +
  labs(title = "After log transformation")

p1 / p2

# Time plot after log transformation
# 20 randomly selected schools
set.seed(1280)
sci_prac_long %>% 
  filter(unit == "year_11_enrolments",
         completion_year != 2019,
         enrolments != 0,
         qcaa_school_id %in% sample(qcaa_school_id, 20)) %>% 
  ggplot(aes(x = completion_year,
             y = log(enrolments),
             group = qcaa_school_id)) +
  geom_line() +
  facet_wrap(~ qcaa_school_id)
```

## Removing completion year that offer chemistry subject for year 11 students but not for year 12 (and vice versa)

```{r}
p1 <- sci_prac %>% 
  ggplot() +
  geom_point(aes(x = year_11_enrolments,
                 y = year_12_enrolments),
             alpha = 0.6) +
  geom_abline(slope = 1,
              colour = "red") +
  labs(title = "All observations") +
  theme(title = element_text(size = 8))

p2 <- sci_prac %>% 
  filter(year_12_enrolments != 0,
         year_11_enrolments != 0) %>% 
  ggplot() +
  geom_point(aes(x = year_11_enrolments,
                 y = year_12_enrolments),
             alpha = 0.6) +
  geom_abline(slope = 1,
              colour = "red") +
  labs(title = "Removed obs. with enrolments in Year 11 but not in Year 12 (and vice versa)") +
  theme(title = element_text(size = 8))
        
p1 / p2
```

```{r}
# ----- Cleaning script
sci_prac <- sci_prac %>% 
  # Remove graduating cohort 2019 
  filter(completion_year != 2019) %>% 
  # Remove schools that offer subject in one of Year 11 or Year 12 only
  filter(year_12_enrolments != 0,
         year_11_enrolments != 0)

sci_prac_long <- sci_prac_long %>% 
  # Remove graduating cohort 2019 
  filter(completion_year != 2019) %>% 
  # Remove schools that offer subject in one of Year 11 or Year 12 only
  filter(enrolments != 0)

# Rescale `completion_year` variable
sci_prac_long <- sci_prac_long %>%
  # Recentre year
  mutate(year10 = completion_year - min(completion_year),
         .before = completion_year) %>% 
  # Log transformation of response variable
  mutate(log_enrolments = log(enrolments))
```

# Unconditional means model

```{r}
# ----- Fit possible null model

# Two-level: Within schools
model0.0 <- lmer(log_enrolments ~ 1 + (1 | qcaa_school_id),
                 data = sci_prac_long)

# Three-level: Schools nested within postcodes
model0.1 <- lmer(log_enrolments ~ 1 + (1 | school_postcode/qcaa_school_id),
                 data = sci_prac_long)

# Three-level Schools nested within districts
model0.2 <- lmer(log_enrolments ~ 1 + (1 | qcaa_district/qcaa_school_id),
                 data = sci_prac_long)
```

```{r}
# Obtain AIC for each null model
model0_AIC <- AIC(model0.0, model0.1, model0.2) 

# Change row names 
rownames(model0_AIC) <- c("Model0.0: Within schools",
                          "Model0.1: Schools nested within postcodes",
                          "Model0.2: Schools nested within districts")

model0_AIC %>% 
  arrange(AIC) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE,
                bootstrap_options = c("hovered", "striped"))
```

- According to the AIC, the two-level model is the best.

## Intraclass correlation ($ICC$)


The **level-two ICC** is the correlation between a school $i$ from a certain district $j$ in time $t$ and in time $t^*$:

$$ICC(school) = \frac{\tau^{2}_{00}}{\tau^{2}_{00} + \phi^{2}_{00} + \sigma^2} = \frac{0.6263}{(0.6263 + 0.4720)} = 0.5702$$

# Unconditional Growth model

```{r}
# Unconditional growth model
model1.0 <- lmer(log_enrolments ~ year10 + (year10 | qcaa_school_id),
                 data = sci_prac_long)
```

# Adding predictors to the model

## Adding `sector`

```{r}
model2.0 <- lmer(log_enrolments ~ year10 + sector + sector:year10 + (year10 | qcaa_school_id),
                 control = lmerControl(optimizer = "bobyqa"),
                 data = sci_prac_long)
```

### Visualising fixed effects

```{r}
fixef(model2.0)
```

## Adding `sector` and `unit`

```{r}
model3.0 <-
  lmer(
    log_enrolments ~ year10 + sector + sector:year10 + unit + unit:year10 +
      (year10 | qcaa_school_id),
    control = lmerControl(optimizer = "bobyqa"),
    data = sci_prac_long
  )
```

### Visualising fixed effects

```{r}
fixef(model3.0)
```

# Testing fixed effects

```{r}
model4.0 <- lmer(log_enrolments ~ year10*sector*unit +
                (year10 | qcaa_school_id),
                REML = FALSE,
                control = lmerControl(optimizer = "bobyqa"),
                data = sci_prac_long)

# ----- Specify all models with different fixed effects

# --- Remove three-way interaction

model4.1 <- update(model4.0, . ~ . - sector:unit:year10)

# --- Remove two two-way interaction

model4.2 <- update(model4.1, . ~. - sector:year10 - unit:year10)

model4.3 <- update(model4.1, . ~. - unit:sector - sector:year10)

model4.4 <- update(model4.1, . ~. - unit:sector - unit:year10)

# --- Remove one two-way interaction

# Remove sector:unit interaction
model4.5 <- update(model4.1, . ~ . - sector:unit)

# Remove sector:year10 interaction
model4.6 <- update(model4.1, . ~ . - sector:year10)

# Remove unit:year10 interaction
model4.7 <- update(model4.1, . ~ . - unit:year10)

# --- No interactions

# Include 3 fixed effects
model4.8 <- update(model4.1, . ~. - unit:year10 - sector:year92 - unit:year10)

# Remove unit fixed effects
model4.9 <- update(model4.8, . ~. - unit)

# Remove sector fixed effects
model4.10 <- update(model4.8, . ~. - sector)
```


```{r}
# ANOVA test
model_anova <- anova(
  model4.0,
  model4.1,
  model4.2,
  model4.3,
  model4.4,
  model4.5,
  model4.6,
  model4.7,
  model4.8,
  model4.9,
  model4.10
)


model_anova %>% 
  as_tibble() %>% 
  select(npar, AIC, BIC, logLik) %>% 
  mutate(model = rownames(model_anova),
         .before = npar) %>% 
  arrange(AIC)
```
Based on the AIC, `model4.1` is the best.

# Parametric bootstrap to test random effects

```{r}
bootstrapAnova <- function(mA, m0, B = 1000){
  oneBootstrap <- function(m0, mA){
    
    # Regenerate new set of response with the null model
    d <- drop(simulate(m0))
    
    # Fit both null and full model to the new data
    m2 <- refit(mA, newresp=d)
    m1 <- refit(m0, newresp=d)
    
    # Return chisq test statistic
    return(anova(m2,m1)$Chisq[2])
  }  
  
  # Conduct test 1,000 times and
  # Store chisq test statistic for each iteration
  nulldist <- replicate(B, oneBootstrap(m0, mA))
  
  # chisq statistic based on the proposed and null model
  ret <- anova(mA, m0)
  
  # Change p-value to bootstrap p-value
  # Proportion of times simulated chisq statistic > actual chisq test statistic
  ret$"Pr(>Chisq)"[2] <- mean(ret$Chisq[2] < nulldist)
  
  # Change name from Pr(>Chisq) to Pr_boot(>Chisq)
  names(ret)[8] <- "Pr_boot(>Chisq)"
  
  # Change heading of model output
  attr(ret, "heading") <- c(attr(ret, "heading")[1], 
    paste("Parametric bootstrap with", B,"samples."),
    attr(ret, "heading")[-1])
  
  attr(ret, "nulldist") <- nulldist
  return(ret)
}
```

```{r}
summary(model4.1)
```


```{r}
# Best model based on AIC and BIC

# Proposed model
balt <- lmer(log_enrolments ~ year10 + sector + year10:sector + unit + year10:unit + sector:unit +
               (year10 | qcaa_school_id),
             REML = FALSE,
             control = lmerControl(optimizer = "bobyqa"),
             data = sci_prac_long)

# Null model
bnull <- lmer(log_enrolments ~ year10 + sector + year10:sector + unit + year10:unit + sector:unit +
               (1 | qcaa_school_id),
              REML = FALSE,
              control = lmerControl(optimizer = "bobyqa"),
              data = sci_prac_long)

actual <- 2*(logLik(balt) - logLik(bnull))
```

```{r, eval=FALSE, warning=FALSE, message=FALSE}
bootstrapLRT <- bootstrapAnova(mA = balt,
                               m0 = bnull, 
                               B = 1000)

save(bootstrapLRT, file = here::here("data/bootstrapLRT/sci-in-prac-model5.0-vs-model5.1.rda"))
```

```{r}
load(here::here("data/bootstrapLRT/sci-in-prac-model5.0-vs-model5.1.rda"))

nullLRT = attr(bootstrapLRT, "nulldist")
x = seq(0, max(nullLRT), length = 100)
y = dchisq(x, 2)

nullLRT.1 <- as.data.frame(cbind(nullLRT = nullLRT, x = x, y = y))

ggplot(nullLRT.1) +
  geom_histogram(
    aes(x = nullLRT, y = ..density..),
    bins = 25,
    color = "black",
    fill = "white"
  ) + 
  geom_vline(xintercept = actual, size = 1) +
  geom_line(aes(x = x, y = y)) +
  # xlim(c(-.5,10)) +
  labs(y = "Density",
       x = "Likelihood Ratio Test Statistics from Null Distribution") 
```

# Confidence interval

```{r}
# Fit best model with restricted maximum likelihood estimates
model_f <- lmer(log_enrolments ~ year10 + sector + year10:sector + unit + year10:unit + sector:unit +
               (year10 | qcaa_school_id),
             REML = TRUE,
             control = lmerControl(optimizer = "bobyqa"),
             data = sci_prac_long)
```

```{r}
confint(model_f,
        method = "boot",
        oldNames = FALSE)
```

# Interpreting final model

## Composite model


- Level one (measurement variable)
$$Y_{tij} = \pi_{0ij} + \pi_{1ij}year10_{tij} + \epsilon_{tij}$$

- Level two (schools within districts) 
  $$\pi_{0ij} = \beta_{00j} + \beta_{01j}sector_{ij} + \beta_{02j}unit_{ij} + \beta_{03j}sector_{ij}unit_{ij} + u_{0ij} \\ 
    \pi_{1ij} = \beta_{10j} + \beta_{11j}sector_{ij} + \beta_{12}unit_{ij} + u_{1ij}$$

Therefore, the composite model can be written as

$$\begin{aligned} Y_{tij} =\ & \pi_{0ij} + \pi_{1ij}year10_{tij} + \epsilon_{tij} \\ =\ & (\beta_{00j} + \beta_{01j}sector_{ij} + \beta_{02j}unit_{ij} + \beta_{03j}sector_{ij}unit_{ij} + u_{0ij}) + \\ & (\beta_{10j} + \beta_{11j}sector_{ij} + \beta_{12}unit_{ij} + u_{1ij})year10_{tij} + \epsilon_{tij} \\ =\ & \left[\beta_{00j} + \beta_{01}sector_{ij} + \beta_{02}unit_{ij} + \beta_{03j}sector_{ij}unit_{ij} + \beta_{10j}year10_{tij} + \beta_{11j}sector_{ij}year_{tij} + \beta_{12}unit_{ij}year10_{tij} \right] \left[u_{0ij} + u_{u_{1ij}} + \epsilon_{tij} \right] \end{aligned}$$
```{r}
# Extract fixed effects for final model
fixef_f <- fixef(model_f)

# \beta_{00j} + \beta_{01}sector_{ij} + \beta_{02}unit_{ij} + \beta_{03j}sector_{ij}unit_{ij} + \beta_{10j}year10_{tij} + 
# \beta_{11j}sector_{ij}year_{tij} + \beta_{12}unit_{ij}year10_{tij} 

# Catholic (unit 11)
fit_cat_unit11 <- fixef_f[[1]] + fixef_f[[2]] * c(0:15) 

# Catholic (unit 12)
fit_cat_unit12 <- fixef_f[[1]] + fixef_f[[5]] + fixef_f[[2]] * c(0:15) + fixef_f[[8]] * c(0:15)
  
# Government (unit 11)
fit_gov_unit11 <- fixef_f[[1]] + fixef_f[[3]] + fixef_f[[2]] * c(0:15) + fixef_f[[6]] * c(0:15) 

# Government (unit 12)
fit_gov_unit12 <-
  fixef_f[[1]] + fixef_f[[3]] + fixef_f[[5]] + fixef_f[[9]] + fixef_f[[2]] * c(0:15) + fixef_f[[6]] * c(0:15) + fixef_f[[8]] * c(0:15)

  
# Independent (unit 11)
fit_ind_unit11 <- fixef_f[[1]] + fixef_f[[4]] + fixef_f[[2]] * c(0:15) + fixef_f[[7]] * c(0:15) 
  
# Independent (unit 12)
fit_ind_unit12 <- fixef_f[[1]] + fixef_f[[4]] + fixef_f[[5]] + fixef_f[[10]] + fixef_f[[2]] * c(0:15) + fixef_f[[7]] * c(0:15) + fixef_f[[8]] * c(0:15)
```

```{r}
fit_f <-
  tibble(
    # Unit 11
    Catholic_unit11 = fit_cat_unit11,
    Government_unit11 = fit_gov_unit11,
    Independent_unit11 = fit_ind_unit11,
    # Unit 12
    Catholic_unit12 = fit_cat_unit12,
    Government_unit12 = fit_gov_unit12,
    Independent_unit12 = fit_ind_unit12,
    # Time variables
    year15 = 0:15,
    completion_year = year15 + 2010
  )

# Convert to long form for plotting
fit_f <- fit_f %>% 
  pivot_longer(cols = Catholic_unit11:Independent_unit12,
               names_to = "sector_unit",
               values_to = "fit") 

# Separate sector and unit into two variables
fit_f <- fit_f %>% 
  separate(sector_unit, 
           into = c("sector", "unit"), 
           sep = "_",
           remove = FALSE) # Keep old variable for grouping in plot
```

```{r}
# Plot fixed effects
fit_f %>% 
  ggplot(aes(x = completion_year,
             y = fit,
             group = sector_unit,
             colour = sector)) +
  geom_line(aes(linetype = unit),
            size = 1,
            alpha = 0.7) +
  scale_colour_discrete_qualitative() +
  labs(title = "Fixed effects of final model",
       x = "Completion Year",
       y = "Predicted log enrolments") +
  theme(legend.position = "bottom",
        legend.direction = "vertical",
        axis.text.x = element_text(angle = 90)) +
  scale_x_continuous(breaks = seq(2010, 2025, by = 1),
                     labels = seq(2010, 2025, by = 1)) 
```
    
## Random effects

```{r}
# Random effects for all schools
ranef_school_f <- as_tibble(ranef(model_f)) %>%
  # Rename intercept and slope names
  mutate(term = if_else(term == "(Intercept)",
                        true = "Intercept",
                        false = "Slope")) %>% 
  rename(qcaa_school_id = grp)
```

```{r}
# Plot random effect for schools nested within districts
ranef_school_f %>% 
  group_by(term) %>% 
  # Reorder group based on by conditional means for plotting
  mutate(qcaa_school_id = fct_reorder(qcaa_school_id, condval)) %>% 
  ggplot() +
  geom_point(aes(x = condval,
                 y = qcaa_school_id)) +
  geom_vline(xintercept = 0,
             size = 1,
             colour = "red") +
  facet_wrap(~ term,
             scales = "free_x")
```
    
    ---
title: "Multilevel Model for Aquatic Practices"
author: "Brendi Ang"
date: "17/10/2021"
output: 
  bookdown::html_document2:
    theme: flatly
    toc: true
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include=FALSE}
library(tidyverse)
library(broom)
library(broom.mixed)
library(colorspace)
library(kableExtra)
library(lme4)
library(patchwork)

ggplot2::theme_set(theme_bw())

select <- dplyr::select
```

```{r, include=FALSE, warning=FALSE}
# Read-in data
mathsci_all <- read_csv(here::here("data/mathsci_all.csv"),
                        col_types = cols(doe_centre_code = col_factor()))

# Convert data types
mathsci_all <- mathsci_all %>% 
  mutate(across(.cols = c(qcaa_subject_id, 
                          subject_type,
                          qcaa_school_id,
                          sector,
                          school_postcode
                          ),
                ~ as.factor(.x))) 
```

```{r}
aqua_prac <- mathsci_all %>% 
  filter(subject_name == "Aquatic Practices")

aqua_prac_long <- aqua_prac %>% 
  pivot_longer(cols = year_11_enrolments:year_12_enrolments,
               names_to = "unit",
               values_to = "enrolments") 
```

# EDA


# Getting the data ready for modelling

## Removing graduating cohort 2019

```{r}
# Year 11 enrolments
p1 <- aqua_prac_long %>% 
  filter(unit == "year_11_enrolments") %>% 
  ggplot() +
  geom_line(aes(x = completion_year,
                y = enrolments,
                group = qcaa_school_id),
            alpha = 0.5,
            colour = "grey40") +
  facet_wrap(~ unit) +
  scale_x_continuous(breaks = seq(1992, 2022, by = 2),
                     labels = seq(1992, 2022, by = 2)) +
  theme(axis.text.x = element_text(angle = 90),
        title = element_text(size = 8)) +
  labs(title = "Enrolments including 2019")

# Year 11 enrolments
p2 <- aqua_prac_long %>% 
  filter(unit == "year_11_enrolments",
         completion_year != 2019) %>% 
  ggplot() +
  geom_line(aes(x = completion_year,
                y = enrolments,
                group = qcaa_school_id),
            alpha = 0.5,
            colour = "grey40") +
  facet_wrap(~ unit) +
  scale_x_continuous(breaks = seq(1992, 2022, by = 2),
                     labels = seq(1992, 2022, by = 2)) +
  theme(axis.text.x = element_text(angle = 90),
        title = element_text(size = 8)) +
  labs(title = "Enrolments excluding 2019")

p1 / p2
```

- As the 2019 graduating cohort were part of the Queensland's first Prep Year cohort in 2007, there were significantly lesser enrolments in that year.
  - Accordingly, 2019 will be removed from the analysis as it is an outlier.

## Linearise response variable using log transformation

```{r}
p1 <- aqua_prac_long %>%
  ggplot(aes(x = enrolments)) +
  geom_histogram() +
  labs(title = "Before log transformation")

p2 <- aqua_prac_long %>%
  ggplot(aes(x = log(enrolments))) +
  geom_histogram() +
  labs(title = "After log transformation")

p1 / p2

# Time plot after log transformation
# 20 randomly selected schools
set.seed(1280)
aqua_prac_long %>% 
  filter(unit == "year_11_enrolments",
         completion_year != 2019,
         enrolments != 0,
         qcaa_school_id %in% sample(qcaa_school_id, 20)) %>% 
  ggplot(aes(x = completion_year,
             y = log(enrolments),
             group = qcaa_school_id)) +
  geom_line() +
  facet_wrap(~ qcaa_school_id)
```

## Removing completion year that offer chemistry subject for year 11 students but not for year 12 (and vice versa)

```{r}
p1 <- aqua_prac %>% 
  ggplot() +
  geom_point(aes(x = year_11_enrolments,
                 y = year_12_enrolments),
             alpha = 0.6) +
  geom_abline(slope = 1,
              colour = "red") +
  labs(title = "All observations") +
  theme(title = element_text(size = 8))

p2 <- aqua_prac %>% 
  filter(year_12_enrolments != 0,
         year_11_enrolments != 0) %>% 
  ggplot() +
  geom_point(aes(x = year_11_enrolments,
                 y = year_12_enrolments),
             alpha = 0.6) +
  geom_abline(slope = 1,
              colour = "red") +
  labs(title = "Removed obs. with enrolments in Year 11 but not in Year 12 (and vice versa)") +
  theme(title = element_text(size = 8))
        
p1 / p2
```

```{r}
aqua_prac <- aqua_prac %>% 
  # Remove graduating cohort 2019 
  filter(completion_year != 2019) %>% 
  # Remove schools that offer subject in one of Year 11 or Year 12 only
  filter(year_12_enrolments != 0,
         year_11_enrolments != 0)

aqua_prac_long <- aqua_prac_long %>% 
  # Remove graduating cohort 2019 
  filter(completion_year != 2019) %>% 
  # Remove schools that offer subject in one of Year 11 or Year 12 only
  filter(enrolments != 0)

# Rescale `completion_year` variable
aqua_prac_long <- aqua_prac_long %>%
  # Recentre year
  mutate(year15 = completion_year - min(completion_year),
         .before = completion_year) %>% 
  # Log transformation of response variable
  mutate(log_enrolments = log(enrolments))
```

# Unconditional means model

```{r}
# ----- Fit possible null model

# Two-level: Within schools
model0.0 <- lmer(log_enrolments ~ 1 + (1 | qcaa_school_id),
                 data = aqua_prac_long)

# Three-level: Schools nested within postcodes
model0.1 <- lmer(log_enrolments ~ 1 + (1 | school_postcode/qcaa_school_id),
                 data = aqua_prac_long)

# Three-level Schools nested within districts
model0.2 <- lmer(log_enrolments ~ 1 + (1 | qcaa_district/qcaa_school_id),
                 data = aqua_prac_long)
```

```{r}
# Obtain AIC for each null model
model0_AIC <- AIC(model0.0, model0.1, model0.2) 

# Change row names 
rownames(model0_AIC) <- c("Model0.0: Within schools",
                          "Model0.1: Schools nested within postcodes",
                          "Model0.2: Schools nested within districts")

model0_AIC %>% 
  arrange(AIC) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE,
                bootstrap_options = c("hovered", "striped"))
```

- According to the AIC, the two-level model is the best.

## Intraclass correlation ($ICC$)


The **level-two ICC** is the correlation between a school $i$ from a certain district $j$ in time $t$ and in time $t^*$:

$$ICC(school) = \frac{\tau^{2}_{00}}{\tau^{2}_{00} + \phi^{2}_{00} + \sigma^2} = \frac{0.6938}{(0.6938 + 0.3834)} = 0.6441$$

# Unconditional Growth model

```{r}
# Unconditional growth model
model1.0 <- lmer(log_enrolments ~ year15 + (year15 | qcaa_school_id),
                 data = aqua_prac_long)
```

- No boundary constraint

# Adding predictors to the model

## Adding `sector`

```{r}
model2.0 <- lmer(log_enrolments ~ year15 + sector + sector:year15 + (year15 | qcaa_school_id),
                 data = aqua_prac_long)
```

### Visualising fixed effects

```{r}
fixef(model2.0)
```

## Adding `sector` and `unit`

```{r}
model2.0 <-
  lmer(
    log_enrolments ~ year15 + sector + sector:year15 + unit + unit:year15 +
      (year15 | qcaa_school_id),
    data = aqua_prac_long
  )
```

### Visualising fixed effects

```{r}
fixef(model3.0)
```

```{r}
model4.0 <- lmer(log_enrolments ~ year15*sector*unit +
                (year15 | qcaa_school_id),
                REML = FALSE,
                data = aqua_prac_long)

# ----- Specify all models with different fixed effects

# --- Remove three-way interaction

model4.1 <- update(model4.0, . ~ . - sector:unit:year15)

# --- Remove two two-way interaction

model4.2 <- update(model4.1, . ~. - sector:year15 - unit:year15)

model4.3 <- update(model4.1, . ~. - unit:sector - sector:year15)

model4.4 <- update(model4.1, . ~. - unit:sector - unit:year15)

# --- Remove one two-way interaction

# Remove sector:unit interaction
model4.5 <- update(model4.1, . ~ . - sector:unit)

# Remove sector:year15 interaction
model4.6 <- update(model4.1, . ~ . - sector:year15)

# Remove unit:year15 interaction
model4.7 <- update(model4.1, . ~ . - unit:year15)

# --- No interactions

# Include 3 fixed effects
model4.8 <- update(model4.1, . ~. - unit:year15 - sector:year15 - unit:year15)

# Remove unit fixed effects
model4.9 <- update(model4.8, . ~. - unit)

# Remove sector fixed effects
model4.10 <- update(model4.8, . ~. - sector)
```

```{r}
# ANOVA test
model_anova <- anova(
  model4.0,
  model4.1,
  model4.2,
  model4.3,
  model4.4,
  model4.5,
  model4.6,
  model4.7,
  model4.8,
  model4.9,
  model4.10
)


model_anova %>% 
  as_tibble() %>% 
  select(npar, AIC, BIC, logLik) %>% 
  mutate(model = rownames(model_anova),
         .before = npar) %>% 
  arrange(AIC)
```

- Based on the AIC, `model4.5` is the best

# Parametric bootstrap to test random effects

```{r}
bootstrapAnova <- function(mA, m0, B = 1000){
  oneBootstrap <- function(m0, mA){
    
    # Regenerate new set of response with the null model
    d <- drop(simulate(m0))
    
    # Fit both null and full model to the new data
    m2 <- refit(mA, newresp=d)
    m1 <- refit(m0, newresp=d)
    
    # Return chisq test statistic
    return(anova(m2,m1)$Chisq[2])
  }  
  
  # Conduct test 1,000 times and
  # Store chisq test statistic for each iteration
  nulldist <- replicate(B, oneBootstrap(m0, mA))
  
  # chisq statistic based on the proposed and null model
  ret <- anova(mA, m0)
  
  # Change p-value to bootstrap p-value
  # Proportion of times simulated chisq statistic > actual chisq test statistic
  ret$"Pr(>Chisq)"[2] <- mean(ret$Chisq[2] < nulldist)
  
  # Change name from Pr(>Chisq) to Pr_boot(>Chisq)
  names(ret)[8] <- "Pr_boot(>Chisq)"
  
  # Change heading of model output
  attr(ret, "heading") <- c(attr(ret, "heading")[1], 
    paste("Parametric bootstrap with", B,"samples."),
    attr(ret, "heading")[-1])
  
  attr(ret, "nulldist") <- nulldist
  return(ret)
}
```

```{r}
summary(model4.5)
```

```{r}
# Best model based on AIC and BIC

# Proposed model
balt <-
  lmer(
    log_enrolments ~ year15 + sector + unit + year15:sector + year15:unit +
      (year15 | qcaa_school_id),
    REML = FALSE,
    data = aqua_prac_long
  )

# Null model
bnull <-
  lmer(
    log_enrolments ~ year15 + sector + unit + year15:sector + year15:unit +
      (1 | qcaa_school_id),
    REML = FALSE,
    data = aqua_prac_long
  )

actual <- 2*(logLik(balt) - logLik(bnull))
```

```{r, eval=FALSE, warning=FALSE, message=FALSE}
bootstrapLRT <- bootstrapAnova(mA = balt,
                               m0 = bnull, 
                               B = 1000)

save(bootstrapLRT, file = here::here("data/aqua-prac-model5.0-vs-model5.1.rda"))
```

```{r}
load(here::here("data/aqua-prac-model5.0-vs-model5.1.rda"))

nullLRT = attr(bootstrapLRT, "nulldist")
x = seq(0, max(nullLRT), length = 100)
y = dchisq(x, 2)

nullLRT.1 <- as.data.frame(cbind(nullLRT = nullLRT, x = x, y = y))

ggplot(nullLRT.1) +
  geom_histogram(
    aes(x = nullLRT, y = ..density..),
    bins = 25,
    color = "black",
    fill = "white"
  ) + 
  geom_vline(xintercept = actual, size = 1) +
  geom_line(aes(x = x, y = y)) +
  # xlim(c(-.5,10)) +
  labs(y = "Density",
       x = "Likelihood Ratio Test Statistics from Null Distribution") 
```

- parametric bootstrap suggests larger model

# Confidence interval

```{r}
# Fit best model with restricted maximum likelihood estimates
model_f <-
  lmer(
    log_enrolments ~ year15 + sector + unit + year15:sector + year15:unit +
      (year15 | qcaa_school_id),
    REML = TRUE,
    data = aqua_prac_long
  )
```

```{r, eval=FALSE}
confint(model_f,
        method = "boot",
        oldNames = FALSE)
```

All parameters are significant except `sectorGovernment`.

## Composite model

```{r}
summary(model_f)
```

```{r}
log_enrolments ~ year15 + sector + unit + year15:sector + year15:unit + (year15 | qcaa_school_id)
```

- Level one (measurement variable)
$$Y_{tij} = \pi_{0ij} + \pi_{1ij}year15_{tij} + \epsilon_{tij}$$

- Level two (schools within postcodes) 
$$\begin{aligned} \pi_{0ij} &= \beta_{00j} + \beta_{01}sector_{ij} + \beta_{02}unit_{ij} + u_{0ij} \\ 
  \pi_{1ij} &= \beta_{10j} + \beta_{11j}sector_{ij} + \beta_{12j}unit_{ij} + u_{1ij} \end{aligned}$$

Therefore, the composite model can be written as

$$\begin{aligned}Y_{tij} =\ &  \pi_{0ij} + \pi_{1ij}year15_{tij} + \epsilon_{tij} \\ =\ & (\beta_{00j} + \beta_{01}sector_{ij} + \beta_{02}unit_{ij} + u_{0ij}) + (\beta_{10j} + \beta_{11j}sector_{ij} + \beta_{12j}unit_{ij} + u_{1ij})year15_{tij} + \epsilon_{tij} \\ =\ & \left[\beta_{00j} + \beta_{01}sector_{ij} + \beta_{02}unit_{ij} + \beta_{10j}year15_{tij} + \beta_{11j}sector_{ij}year15_{tij} + \beta_{12j}unit_{ij}year15_{tij} \right] \left[u_{0ij} + u_{1ij} + \epsilon_{tij} \right] \end{aligned}$$

```{r}
# Extract fixed effects for final model
fixef_f <- fixef(model_f)

# \beta_{00j} + \beta_{01}sector_{ij} + \beta_{02}unit_{ij} + \beta_{10j}year15_{tij} + 
# \beta_{11j}sector_{ij}year15_{tij} + \beta_{12j}unit_{ij}year15_{tij

# Catholic (unit 11)
fit_cat_unit11 <- fixef_f[[1]] + fixef_f[[5]] + fixef_f[[2]] * c(0:10) + fixef_f[[1]] 

# Catholic (unit 12)
fit_cat_unit12 <- fixef_f[[1]] + fixef_f[[5]] + fixef_f[[2]] * c(0:10) + fixef_f[[8]] * c(0:10)
  
# Government (unit 11)
fit_gov_unit11 <- fixef_f[[1]] + fixef_f[[3]] + fixef_f[[2]] * c(0:10) + fixef_f[[6]]  * c(0:10) + fixef_f[[8]] * c(0:10) 

# Government (unit 12)
fit_gov_unit12 <- fixef_f[[1]] + fixef_f[[3]] + fixef_f[[5]] + fixef_f[[6]] * c(0:10) + fixef_f[[8]] * c(0:10) 
  
# Independent (unit 11)
fit_ind_unit11 <- fixef_f[[1]] + fixef_f[[4]] + fixef_f[[2]] * c(0:10) + fixef_f[[7]] * c(0:10)
  
# Independent (unit 12)
fit_ind_unit12 <- fixef_f[[1]] + fixef_f[[4]] + fixef_f[[5]] + fixef_f[[2]] * c(0:10) + fixef_f[[7]] * c(0:10) + fixef_f[[8]]* c(0:10)
```

```{r}
fit_f <-
  tibble(
    # Unit 11
    Catholic_unit11 = fit_cat_unit11,
    Government_unit11 = fit_gov_unit11,
    Independent_unit11 = fit_ind_unit11,
    # Unit 12
    Catholic_unit12 = fit_cat_unit12,
    Government_unit12 = fit_gov_unit12,
    Independent_unit12 = fit_ind_unit12,
    # Time variables
    year15 = 0:10,
    completion_year = year15 + 2015
  )

# Convert to long form for plotting
fit_f <- fit_f %>% 
  pivot_longer(cols = Catholic_unit11:Independent_unit12,
               names_to = "sector_unit",
               values_to = "fit") 

# Separate sector and unit into two variables
fit_f <- fit_f %>% 
  separate(sector_unit, 
           into = c("sector", "unit"), 
           sep = "_",
           remove = FALSE) # Keep old variable for grouping in plot
```

```{r}
# Plot fixed effects
fit_f %>% 
  ggplot(aes(x = completion_year,
             y = fit,
             group = sector_unit,
             colour = sector)) +
  geom_line(aes(linetype = unit),
            size = 1,
            alpha = 0.7) +
  scale_colour_discrete_qualitative() +
  labs(title = "Fixed effects of final model",
       x = "Completion Year",
       y = "Predicted log enrolments") +
  theme(legend.position = "bottom",
        legend.direction = "vertical",
        axis.text.x = element_text(angle = 90)) +
  scale_x_continuous(breaks = seq(2015, 2025, by = 1),
                     labels = seq(2015, 2025, by = 1)) 
```

## Random effects

```{r}
# Random effects for all schools
ranef_school_f <- as_tibble(ranef(model_f)) %>%
  # Rename intercept and slope names
  mutate(term = if_else(term == "(Intercept)",
                        true = "Intercept",
                        false = "Slope")) %>% 
  rename(qcaa_school_id = grp)
```

```{r}
# Plot random effect for schools nested within districts
ranef_school_f %>% 
  group_by(term) %>% 
  # Reorder group based on by conditional means for plotting
  mutate(qcaa_school_id = fct_reorder(qcaa_school_id, condval)) %>% 
  ggplot() +
  geom_point(aes(x = condval,
                 y = qcaa_school_id)) +
  geom_vline(xintercept = 0,
             size = 1,
             colour = "red") +
  facet_wrap(~ term,
             scales = "free_x")
```

## Predictions

```{r}
# Predictions for 20 randomly selected schools for year 11 enrolments
set.seed(1234)

sci_prac_long %>% 
  filter(unit == "year_11_enrolments") %>% 
  filter(qcaa_school_id %in% sample(qcaa_school_id, 20)) %>% 
  mutate(pred = predict(model_f, newdata = .)) %>% 
  ggplot() +
  geom_line(aes(x = completion_year,
                y = log(enrolments),
                group = qcaa_school_id)) +
  geom_line(aes(x = completion_year,
                y = pred,
                group = qcaa_school_id),
            colour = "orange") +
  facet_wrap(~ qcaa_school_id)
```
    
    
  
    
    

  
    
    
    
    
    
    
    
    
    
    
    
